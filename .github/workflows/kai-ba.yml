name: KAI-BA Cloud Run Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'libs/**'
      - 'apps/kai-ba/**'
      - 'docker/kai-ba/**'
      - '.github/workflows/kai-ba.yml'
      - '.github/gcp/kai-ba-cloudrun.yml'

env:
  # Docker è¨­å®š
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE_NAME: a9293340/kai-ba

  # Cloud Run è¨­å®š
  CLOUD_RUN_REGION: asia-northeast1
  CLOUD_RUN_SERVICE: kai-ba

  # å¯é¸ï¼šå¦‚æžœæƒ³è¦å¾ž secrets è®€å–ï¼Œå¯ä»¥æ”¹ç‚º:
  # CLOUD_RUN_REGION: ${{ secrets.CLOUD_RUN_REGION || 'asia-northeast1' }}
  # CLOUD_RUN_SERVICE: ${{ secrets.CLOUD_RUN_SERVICE || 'kai-ba' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate deployment tag with high discriminability
        id: tag
        run: |
          # ç”Ÿæˆå”¯ä¸€éƒ¨ç½²æ¨™ç±¤: {branch}-{timestamp}-{commit}
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          # æ¸…ç† branch åç¨±ï¼Œç§»é™¤ç‰¹æ®Šå­—å…ƒ
          BRANCH_CLEAN=$(echo "${BRANCH_NAME}" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          TIMESTAMP=$(date +"%Y%m%d-%H%M")
          COMMIT_SHORT="${GITHUB_SHA:0:7}"

          DEPLOY_TAG="${BRANCH_CLEAN}-${TIMESTAMP}-${COMMIT_SHORT}"

          echo "deploy_tag=${DEPLOY_TAG}" >> $GITHUB_OUTPUT
          echo "branch_clean=${BRANCH_CLEAN}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT

          echo "=== éƒ¨ç½²æ¨™ç±¤è³‡è¨Š ==="
          echo "ðŸŒ¿ Branch: ${BRANCH_NAME} -> ${BRANCH_CLEAN}"
          echo "â° Timestamp: ${TIMESTAMP}"
          echo "ðŸ“ Commit: ${GITHUB_SHA:0:7}"
          echo "ðŸ·ï¸  Final Tag: ${DEPLOY_TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: a9293340
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/kai-ba/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.deploy_tag }}
            ${{ env.DOCKER_IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            deployment.tag=${{ steps.tag.outputs.deploy_tag }}
            deployment.branch=${{ steps.tag.outputs.branch_clean }}
            deployment.commit=${{ steps.tag.outputs.commit_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_TOKEN_JSON }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure gcloud project
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud auth configure-docker

      - name: Validate Cloud Run configuration
        run: |
          echo "=== é©—è­‰éƒ¨ç½²é…ç½® ==="
          echo "ðŸŒ Region: ${{ env.CLOUD_RUN_REGION }}"
          echo "ðŸš€ Service: ${{ env.CLOUD_RUN_SERVICE }}"
          echo "ðŸ·ï¸  Deploy Tag: ${{ steps.tag.outputs.deploy_tag }}"
          echo "ðŸ³ Image: ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.deploy_tag }}"

          # æª¢æŸ¥æœå‹™æ˜¯å¦å­˜åœ¨
          if gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
             --region=${{ env.CLOUD_RUN_REGION }} \
             --project=${{ secrets.GCP_PROJECT_ID }} >/dev/null 2>&1; then
            echo "âœ… Service exists, will update"
          else
            echo "ðŸ†• Service doesn't exist, will create"
          fi

      - name: Create deployment-specific Cloud Run YAML
        run: |
          # è¤‡è£½åŽŸå§‹ YAML åˆ°è‡¨æ™‚æª”æ¡ˆ
          cp .github/gcp/kai-ba-cloudrun.yml /tmp/kai-ba-deploy.yml

          # æ›´æ–° image tag
          sed -i 's|image: .*|image: ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.deploy_tag }}|g' /tmp/kai-ba-deploy.yml

          # åœ¨ template.metadata.annotations ä¸­æ·»åŠ éƒ¨ç½²è³‡è¨Š
          sed -i '/template:/,/spec:/ {
            /metadata:/,/spec:/ {
              /annotations:/a\
          run.googleapis.com/deployment-tag: "${{ steps.tag.outputs.deploy_tag }}"
              /annotations:/a\
          run.googleapis.com/deployment-branch: "${{ steps.tag.outputs.branch_clean }}"
              /annotations:/a\
          run.googleapis.com/deployment-commit: "${{ steps.tag.outputs.commit_short }}"
              /annotations:/a\
          run.googleapis.com/deployment-timestamp: "${{ steps.tag.outputs.timestamp }}"
            }
          }' /tmp/kai-ba-deploy.yml

          echo "=== Generated deployment YAML preview ==="
          head -50 /tmp/kai-ba-deploy.yml

      - name: Deploy to Cloud Run
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ° Cloud Run..."
          gcloud run services replace /tmp/kai-ba-deploy.yml \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Update traffic to new revision
        run: |
          # å–å¾—æœ€æ–°çš„ revision åç¨±
          LATEST_REVISION=$(gcloud run revisions list \
            --service=${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --limit=1 \
            --format='value(metadata.name)')

          echo "ðŸ“¦ Latest revision: ${LATEST_REVISION}"

          # å°‡ 100% æµé‡å°Žå‘æ–°çš„ revision
          gcloud run services update-traffic ${{ env.CLOUD_RUN_SERVICE }} \
            --to-revisions=${LATEST_REVISION}=100 \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

          # ç‚ºæ–° revision è¨­å®š tag (ç”¨æ–¼ URL è·¯ç”±)
          gcloud run services update-traffic ${{ env.CLOUD_RUN_SERVICE }} \
            --set-tags=${{ steps.tag.outputs.deploy_tag }}=${LATEST_REVISION} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

          echo "âœ… Traffic updated to revision: ${LATEST_REVISION}"

      - name: Wait for deployment to be ready
        run: |
          echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
          gcloud run services wait ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}
          echo "âœ… éƒ¨ç½²å·²å°±ç·’"

      - name: Get service URLs
        id: urls
        run: |
          # ä¸»è¦æœå‹™ URL
          SERVICE_URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(status.url)')

          # å¸¶ tag çš„ URL (ç”¨æ–¼æ¸¬è©¦ç‰¹å®šç‰ˆæœ¬)
          TAGGED_URL=$(echo ${SERVICE_URL} | sed 's|https://|https://${{ steps.tag.outputs.deploy_tag }}---|')

          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "tagged_url=${TAGGED_URL}" >> $GITHUB_OUTPUT

          echo "ðŸš€ Service deployed successfully!"
          echo "ðŸ“ Service URL: ${SERVICE_URL}"
          echo "ðŸ·ï¸  Tagged URL: ${TAGGED_URL}"

      - name: Health check
        run: |
          echo "ðŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."

          # ä¸»è¦ URL å¥åº·æª¢æŸ¥
          for i in {1..5}; do
            if curl -f -s "${{ steps.urls.outputs.service_url }}/_hc" >/dev/null; then
              echo "âœ… ä¸»è¦ URL å¥åº·æª¢æŸ¥é€šéŽ!"
              break
            else
              echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•— (å˜—è©¦ $i/5)"
              if [ $i -eq 5 ]; then
                echo "ðŸš¨ å¥åº·æª¢æŸ¥åœ¨ 5 æ¬¡å˜—è©¦å¾Œå¤±æ•—"
                exit 1
              fi
              sleep 10
            fi
          done

          # Tagged URL å¥åº·æª¢æŸ¥ (å¯é¸)
          echo "ðŸ·ï¸  æ¸¬è©¦æ¨™ç±¤ URL..."
          if curl -f -s "${{ steps.urls.outputs.tagged_url }}/_hc" >/dev/null; then
            echo "âœ… æ¨™ç±¤ URL å¥åº·æª¢æŸ¥é€šéŽ!"
          else
            echo "âš ï¸  æ¨™ç±¤ URL å¥åº·æª¢æŸ¥å¤±æ•— (DNS å‚³æ’­å¯èƒ½éœ€è¦æ™‚é–“)"
          fi

      - name: Cleanup temporary files
        run: |
          rm -f /tmp/kai-ba-deploy.yml
          echo "ðŸ§¹ æ¸…ç†å®Œæˆ"

      - name: Create deployment summary
        run: |
          # å–å¾— revision è³‡è¨Š
          LATEST_REVISION=$(gcloud run revisions list \
            --service=${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --limit=1 \
            --format='value(metadata.name)')

          # å–å¾—å‰ä¸€å€‹ revision (ç”¨æ–¼å›žæ»¾)
          PREVIOUS_REVISION=$(gcloud run revisions list \
            --service=${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --limit=2 \
            --format='value(metadata.name)' | tail -n 1)

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ KAI-BA Deployment Summary

          **âœ… Deployment Status:** Success
          **ðŸ·ï¸  Deploy Tag:** \`${{ steps.tag.outputs.deploy_tag }}\`
          **ðŸŒ¿ Branch:** \`${{ steps.tag.outputs.branch_clean }}\`
          **â° Timestamp:** \`${{ steps.tag.outputs.timestamp }}\`
          **ðŸ“ Commit:** \`${{ steps.tag.outputs.commit_short }}\`
          **ðŸ³ Docker Image:** \`${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.deploy_tag }}\`

          ### ðŸŒ Service URLs
          - **Main URL:** [${{ steps.urls.outputs.service_url }}](${{ steps.urls.outputs.service_url }})
          - **Health Check:** [${{ steps.urls.outputs.service_url }}/_hc](${{ steps.urls.outputs.service_url }}/_hc)
          - **Tagged URL:** [${{ steps.urls.outputs.tagged_url }}](${{ steps.urls.outputs.tagged_url }})

          ### ðŸ“¦ Cloud Run Information
          - **Service:** \`${{ env.CLOUD_RUN_SERVICE }}\`
          - **Region:** \`${{ env.CLOUD_RUN_REGION }}\`
          - **Current Revision:** \`${LATEST_REVISION}\`
          - **Previous Revision:** \`${PREVIOUS_REVISION}\`

          ### ðŸ“Š Build Information
          - **Commit SHA:** \`${GITHUB_SHA:0:8}\`
          - **Full SHA:** \`${GITHUB_SHA}\`
          - **Branch:** \`${GITHUB_REF_NAME}\`
          - **Triggered by:** ${GITHUB_ACTOR}
          - **Deployed At:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### ðŸŽ¯ Quick Commands
          \`\`\`bash
          # æŸ¥çœ‹æœå‹™ç‹€æ…‹
          gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} --region=${{ env.CLOUD_RUN_REGION }}

          # å›žæ»¾åˆ°å‰ä¸€ç‰ˆæœ¬
          gcloud run services update-traffic ${{ env.CLOUD_RUN_SERVICE }} \\
            --to-revisions=\${PREVIOUS_REVISION}=100 \\
            --region=${{ env.CLOUD_RUN_REGION }}

          # æŸ¥çœ‹æ—¥èªŒ
          gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.CLOUD_RUN_SERVICE }}" --limit=50

          # æŸ¥çœ‹ç‰¹å®šæ¨™ç±¤çš„ revision
          gcloud run revisions describe \${LATEST_REVISION} --region=${{ env.CLOUD_RUN_REGION }}
          \`\`\`
          EOF

      - name: Output deployment information
        run: |
          echo "=== ðŸŽ‰ éƒ¨ç½²å®Œæˆ ==="
          echo "Deploy Tag: ${{ steps.tag.outputs.deploy_tag }}"
          echo "Service URL: ${{ steps.urls.outputs.service_url }}"
          echo "Tagged URL: ${{ steps.urls.outputs.tagged_url }}"
