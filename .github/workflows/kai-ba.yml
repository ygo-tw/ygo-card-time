name: KAI-BA Cloud Run Pipeline

on:
  push:
    branches:
      - main
    # æš«æ™‚ç§»é™¤ paths é™åˆ¶ï¼Œæ–¹ä¾¿æ¸¬è©¦
    # paths:
    #   - 'libs/**'
    #   - 'apps/kai-ba/**'
    #   - 'docker/kai-ba/**'
    #   - '.github/workflows/kai-ba.yml'
    #   - '.github/gcp/kai-ba-cloudrun.yml'

env:
  # Docker è¨­å®š
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE_NAME: a9293340/kai-ba

  # Cloud Run è¨­å®š
  CLOUD_RUN_REGION: asia-northeast1
  CLOUD_RUN_SERVICE: kai-ba

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate deployment tag with high discriminability
        id: tag
        run: |
          # ç”Ÿæˆå”¯ä¸€éƒ¨ç½²æ¨™ç±¤: {branch}-{timestamp}-{commit}
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          # æ¸…ç† branch åç¨±ï¼Œç§»é™¤ç‰¹æ®Šå­—å…ƒ
          BRANCH_CLEAN=$(echo "${BRANCH_NAME}" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          TIMESTAMP=$(date +"%Y%m%d-%H%M")
          COMMIT_SHORT="${GITHUB_SHA:0:7}"

          DEPLOY_TAG="${BRANCH_CLEAN}-${TIMESTAMP}-${COMMIT_SHORT}"

          echo "deploy_tag=${DEPLOY_TAG}" >> $GITHUB_OUTPUT
          echo "branch_clean=${BRANCH_CLEAN}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "commit_short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT

          echo "=== éƒ¨ç½²æ¨™ç±¤è³‡è¨Š ==="
          echo "ðŸŒ¿ Branch: ${BRANCH_NAME} -> ${BRANCH_CLEAN}"
          echo "â° Timestamp: ${TIMESTAMP}"
          echo "ðŸ“ Commit: ${GITHUB_SHA:0:7}"
          echo "ðŸ·ï¸  Final Tag: ${DEPLOY_TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: a9293340
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/kai-ba/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.deploy_tag }}
            ${{ env.DOCKER_IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            deployment.tag=${{ steps.tag.outputs.deploy_tag }}
            deployment.branch=${{ steps.tag.outputs.branch_clean }}
            deployment.commit=${{ steps.tag.outputs.commit_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_TOKEN_JSON }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure gcloud project
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud auth configure-docker

      - name: Validate Cloud Run configuration
        run: |
          echo "=== é©—è­‰éƒ¨ç½²é…ç½® ==="
          echo "ðŸŒ Region: ${{ env.CLOUD_RUN_REGION }}"
          echo "ðŸš€ Service: ${{ env.CLOUD_RUN_SERVICE }}"
          echo "ðŸ·ï¸  Deploy Tag: ${{ steps.tag.outputs.deploy_tag }}"
          echo "ðŸ³ Image: ${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.deploy_tag }}"

          # æª¢æŸ¥æœå‹™æ˜¯å¦å­˜åœ¨
          if gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
             --region=${{ env.CLOUD_RUN_REGION }} \
             --project=${{ secrets.GCP_PROJECT_ID }} >/dev/null 2>&1; then
            echo "âœ… Service exists, will update"
          else
            echo "ðŸ†• Service doesn't exist, will create"
          fi

      - name: Create deployment-specific Cloud Run YAML
        run: |
          # è¤‡è£½åŽŸå§‹ YAML åˆ°è‡¨æ™‚æª”æ¡ˆ
          cp .github/gcp/kai-ba-cloudrun.yml /tmp/kai-ba-deploy.yml

          # ä½¿ç”¨ python ä¾†å®‰å…¨åœ°ä¿®æ”¹ YAML
          python3 << 'EOF'
          import yaml
          import sys

          # è®€å– YAML
          with open('/tmp/kai-ba-deploy.yml', 'r') as f:
              data = yaml.safe_load(f)

          # æ›´æ–° image
          if 'spec' in data and 'template' in data['spec'] and 'spec' in data['spec']['template']:
              containers = data['spec']['template']['spec'].get('containers', [])
              for container in containers:
                  if container.get('name') == 'kai-ba':
                      container['image'] = '${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.deploy_tag }}'

          # ç¢ºä¿ service level metadata.annotations å­˜åœ¨ä¸¦åŒ…å« invoker-iam-disabled
          if 'metadata' not in data:
              data['metadata'] = {}
          if 'annotations' not in data['metadata']:
              data['metadata']['annotations'] = {}

          # æ˜Žç¢ºè¨­å®šå…è¨±å…¬é–‹è¨ªå• - æ­£ç¢ºçš„å€¼æ‡‰è©²æ˜¯ 'true'
          data['metadata']['annotations']['run.googleapis.com/invoker-iam-disabled'] = 'true'
          print("=== è¨­å®š invoker-iam-disabled: 'true' (å…è¨±å…¬é–‹è¨ªå•) ===")

          # æ·»åŠ éƒ¨ç½²è³‡è¨Šåˆ° template annotations
          if 'spec' in data and 'template' in data['spec']:
              if 'metadata' not in data['spec']['template']:
                  data['spec']['template']['metadata'] = {}
              if 'annotations' not in data['spec']['template']['metadata']:
                  data['spec']['template']['metadata']['annotations'] = {}
              
              template_annotations = data['spec']['template']['metadata']['annotations']
              template_annotations['run.googleapis.com/deployment-tag'] = '${{ steps.tag.outputs.deploy_tag }}'
              template_annotations['run.googleapis.com/deployment-branch'] = '${{ steps.tag.outputs.branch_clean }}'
              template_annotations['run.googleapis.com/deployment-commit'] = '${{ steps.tag.outputs.commit_short }}'
              template_annotations['run.googleapis.com/deployment-timestamp'] = '${{ steps.tag.outputs.timestamp }}'

          # å¯«å›ž YAML
          with open('/tmp/kai-ba-deploy.yml', 'w') as f:
              yaml.dump(data, f, default_flow_style=False, allow_unicode=True)
          EOF

          echo "=== Generated deployment YAML preview ==="
          head -50 /tmp/kai-ba-deploy.yml

          echo "=== YAML validation ==="
          python3 -c "import yaml; yaml.safe_load(open('/tmp/kai-ba-deploy.yml'))" && echo "âœ… YAML is valid" || echo "âŒ YAML is invalid"

          echo "=== æª¢æŸ¥ invoker-iam-disabled è¨­å®š ==="
          grep -n "invoker-iam-disabled" /tmp/kai-ba-deploy.yml || echo "âš ï¸  æœªæ‰¾åˆ° invoker-iam-disabled è¨­å®š"

      - name: Deploy to Cloud Run
        run: |
          echo "ðŸš€ éƒ¨ç½²åˆ° Cloud Run..."
          gcloud run services replace /tmp/kai-ba-deploy.yml \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Update traffic to new revision
        run: |
          # å–å¾—æœ€æ–°çš„ revision åç¨±
          LATEST_REVISION=$(gcloud run revisions list \
            --service=${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --limit=1 \
            --format='value(metadata.name)')

          echo "ðŸ“¦ Latest revision: ${LATEST_REVISION}"

          # å°‡ 100% æµé‡å°Žå‘æ–°çš„ revision
          gcloud run services update-traffic ${{ env.CLOUD_RUN_SERVICE }} \
            --to-revisions=${LATEST_REVISION}=100 \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

          # ç‚ºæ–° revision è¨­å®š tag (ç”¨æ–¼ URL è·¯ç”±)
          gcloud run services update-traffic ${{ env.CLOUD_RUN_SERVICE }} \
            --set-tags=${{ steps.tag.outputs.deploy_tag }}=${LATEST_REVISION} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

          echo "âœ… Traffic updated to revision: ${LATEST_REVISION}"

      - name: Wait for deployment to be ready
        run: |
          echo "â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
          # æª¢æŸ¥æœå‹™ç‹€æ…‹è€Œä¸æ˜¯ä½¿ç”¨ä¸å­˜åœ¨çš„ wait æŒ‡ä»¤
          for i in {1..10}; do
            STATUS=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
              --region=${{ env.CLOUD_RUN_REGION }} \
              --project=${{ secrets.GCP_PROJECT_ID }} \
              --format='value(status.conditions[0].status)')
            
            if [ "$STATUS" = "True" ]; then
              echo "âœ… éƒ¨ç½²å·²å°±ç·’"
              break
            else
              echo "â³ ç­‰å¾…ä¸­... (å˜—è©¦ $i/10)"
              if [ $i -eq 10 ]; then
                echo "âš ï¸  ç­‰å¾…è¶…æ™‚ï¼Œä½†æœå‹™å¯èƒ½ä»åœ¨å•Ÿå‹•ä¸­"
              fi
              sleep 5
            fi
          done

      - name: Get service URLs
        id: urls
        run: |
          # ä¸»è¦æœå‹™ URL
          SERVICE_URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --format='value(status.url)')

          # å¸¶ tag çš„ URL (ç”¨æ–¼æ¸¬è©¦ç‰¹å®šç‰ˆæœ¬)
          TAGGED_URL=$(echo ${SERVICE_URL} | sed 's|https://|https://${{ steps.tag.outputs.deploy_tag }}---|')

          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "tagged_url=${TAGGED_URL}" >> $GITHUB_OUTPUT

          echo "ðŸš€ Service deployed successfully!"
          echo "ðŸ“ Service URL: ${SERVICE_URL}"
          echo "ðŸ·ï¸  Tagged URL: ${TAGGED_URL}"

      - name: Health check
        run: |
          echo "ðŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."

          # ä¸»è¦ URL å¥åº·æª¢æŸ¥
          for i in {1..5}; do
            if curl -f -s "${{ steps.urls.outputs.service_url }}/_hc" >/dev/null; then
              echo "âœ… ä¸»è¦ URL å¥åº·æª¢æŸ¥é€šéŽ!"
              break
            else
              echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•— (å˜—è©¦ $i/5)"
              if [ $i -eq 5 ]; then
                echo "ðŸš¨ å¥åº·æª¢æŸ¥åœ¨ 5 æ¬¡å˜—è©¦å¾Œå¤±æ•—"
                exit 1
              fi
              sleep 10
            fi
          done

          # Tagged URL å¥åº·æª¢æŸ¥ (å¯é¸)
          echo "ðŸ·ï¸  æ¸¬è©¦æ¨™ç±¤ URL..."
          if curl -f -s "${{ steps.urls.outputs.tagged_url }}/_hc" >/dev/null; then
            echo "âœ… æ¨™ç±¤ URL å¥åº·æª¢æŸ¥é€šéŽ!"
          else
            echo "âš ï¸  æ¨™ç±¤ URL å¥åº·æª¢æŸ¥å¤±æ•— (DNS å‚³æ’­å¯èƒ½éœ€è¦æ™‚é–“)"
          fi

      - name: Cleanup temporary files
        run: |
          rm -f /tmp/kai-ba-deploy.yml
          echo "ðŸ§¹ æ¸…ç†å®Œæˆ"

      - name: Create deployment summary
        run: |
          # å–å¾— revision è³‡è¨Š
          LATEST_REVISION=$(gcloud run revisions list \
            --service=${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --limit=1 \
            --format='value(metadata.name)')

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ KAI-BA Deployment Summary

          **âœ… Deployment Status:** Success
          **ðŸ·ï¸  Deploy Tag:** \`${{ steps.tag.outputs.deploy_tag }}\`
          **ðŸŒ¿ Branch:** \`${{ steps.tag.outputs.branch_clean }}\`
          **â° Timestamp:** \`${{ steps.tag.outputs.timestamp }}\`
          **ðŸ“ Commit:** \`${{ steps.tag.outputs.commit_short }}\`
          **ðŸ³ Docker Image:** \`${{ env.DOCKER_IMAGE_NAME }}:${{ steps.tag.outputs.deploy_tag }}\`

          ### ðŸŒ Service URLs
          - **Main URL:** [${{ steps.urls.outputs.service_url }}](${{ steps.urls.outputs.service_url }})
          - **Health Check:** [${{ steps.urls.outputs.service_url }}/_hc](${{ steps.urls.outputs.service_url }}/_hc)
          - **Tagged URL:** [${{ steps.urls.outputs.tagged_url }}](${{ steps.urls.outputs.tagged_url }})

          ### ðŸ“¦ Cloud Run Information
          - **Service:** \`${{ env.CLOUD_RUN_SERVICE }}\`
          - **Region:** \`${{ env.CLOUD_RUN_REGION }}\`
          - **Current Revision:** \`${LATEST_REVISION}\`

          ### ðŸ“Š Build Information
          - **Commit SHA:** \`${GITHUB_SHA:0:8}\`
          - **Branch:** \`${GITHUB_REF_NAME}\`
          - **Triggered by:** ${GITHUB_ACTOR}
          - **Deployed At:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF
